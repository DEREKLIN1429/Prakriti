function doPost(e) {
  try {
    // 1. 取得前端傳來的資料
    var data = JSON.parse(e.postData.contents);
    var note = data.note;
    var imageBase64 = data.image;
    var folderId = data.folderId; // 這裡會接收前端寫死的那個 ID

    var fileUrl = "";

    // 2. 處理圖片 (如果有圖片)
    if (imageBase64 && imageBase64 !== "") {
      // 去除 base64 標頭 (data:image/jpeg;base64,...)
      var contentType = imageBase64.substring(5, imageBase64.indexOf(';'));
      var base64Content = imageBase64.substring(imageBase64.indexOf(',') + 1);
      
      var blob = Utilities.newBlob(Utilities.base64Decode(base64Content), contentType, "Photo_" + new Date().getTime() + ".jpg");
      
      // 存入指定資料夾
      var folder;
      try {
        folder = DriveApp.getFolderById(folderId);
      } catch(err) {
        // 如果找不到資料夾，就存根目錄 (預防萬一)
        folder = DriveApp.getRootFolder();
      }
      var file = folder.createFile(blob);
      fileUrl = file.getUrl();
      
      // 設定檔案權限為 "知道連結者皆可檢視" (避免圖片無法在 Excel 顯示)
      file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    }

    // 3. 存入 Google Sheet (請確認下面的 ID 是否正確)
    // 雖然 HTML 有寫死 Sheet ID，但那是給 "檢視按鈕" 用的。
    // 後端這裡也要告訴它存到哪一張表。
    var sheetId = "1SuuMVdfpLq720Yd0trlxWoU9f-aBCfR4vbJZ-0GfyIU"; // 這是你剛才給的 Sheet ID
    var sheet = SpreadsheetApp.openById(sheetId).getSheets()[0]; // 抓第一張工作表
    
    // 寫入一行：[時間, 筆記內容, 圖片連結]
    sheet.appendRow([new Date(), note, fileUrl]);

    // 4. 回傳成功訊息 (這一步最重要，一定要回傳 JSON)
    return ContentService.createTextOutput(JSON.stringify({ "status": "success" }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    // 發生錯誤回傳
    return ContentService.createTextOutput(JSON.stringify({ "status": "error", "message": error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
